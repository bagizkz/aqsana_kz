{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}AQSANA.KZ ‚Äî –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä{% endblock %}

{% block content %}
<h2 class="text-center fw-semibold my-5">–†–µ—Å–º–∏ –∞–π—ã—Ä–±–∞—Å—Ç–∞—É –±–∞“ì–∞–º—ã. –°–ø—Ä–µ–¥—Å—ñ–∑</h2>

<form method="post" novalidate class="mb-5">
    {% csrf_token %}
    <div class="row mb-4">
        <div class="col-8">
            <label class="form-label text-muted">–°–æ–º–∞</label>
            {{ form.amount|add_class:"form-control form-control-lg rounded-3 border border-secondary-subtle" }}
        </div>
        <div class="col-4">
            <label class="form-label text-muted">–í–∞–ª—é—Ç–∞–¥–∞–Ω</label>
            {{ form.from_currency|add_class:"form-select form-select-lg rounded-3 border border-secondary-subtle" }}
        </div>
    </div>

    <div class="mb-4">
        <label class="form-label text-muted">–í–∞–ª—é—Ç–∞“ì–∞</label>
        {{ form.to_currency|add_class:"form-select form-select-lg rounded-3 border border-secondary-subtle" }}
    </div>

    <button type="submit" class="btn btn-dark w-100 py-3 fs-5">üîÑ –ê–π—ã—Ä–±–∞—Å—Ç–∞—É</button>
</form>

{% if form.non_field_errors %}
<div class="alert alert-warning text-center">{{ form.non_field_errors.0 }}</div>
{% endif %}

{% if result %}
<div class="alert alert-light border-start border-5 border-success shadow-sm fs-5">
    üí∞ <strong>–ù”ô—Ç–∏–∂–µ:</strong> {{ result }}
</div>
{% endif %}

{% if prediction %}
<div class="mt-5">
    <h5 class="text-muted mb-3">üìà KZT ‚Üí USD 7 –∫“Ø–Ω–≥–µ –±–æ–ª–∂–∞–º—ã:</h5>
    <ul class="list-group list-group-flush">
        {% for item in prediction %}
        <li class="list-group-item d-flex justify-content-between px-0">
            <span>{{ item.date }}</span>
            <span class="fw-bold">{{ item.rate }}</span>
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% if user.is_authenticated and form.cleaned_data.from_currency and form.cleaned_data.to_currency %}
{% with from_code=form.cleaned_data.from_currency.code to_code=form.cleaned_data.to_currency.code %}
{% with direction=from_code|add:"-"|add:to_code %}
<div class="mt-4">
    {% if direction in favorite_strings %}
    <a href="{% url 'remove_from_favorites' from_code to_code %}" class="btn btn-outline-danger w-100">
        ‚ùå –¢–∞“£–¥–∞—É–ª—ã–ª–∞—Ä–¥–∞–Ω ”©—à—ñ—Ä—É: {{ from_code }} ‚Üí {{ to_code }}
    </a>
    {% else %}
    <a href="{% url 'add_to_favorites' from_code to_code %}" class="btn btn-outline-secondary w-100">
        ‚≠ê –¢–∞“£–¥–∞—É–ª—ã“ì–∞ “õ–æ—Å—É: {{ from_code }} ‚Üí {{ to_code }}
    </a>
    {% endif %}
</div>
{% endwith %}
{% endwith %}
{% endif %}

<!-- {% if ai_forecast %}
<div class="mt-5">
    <h5 class="text-muted mb-3">ü§ñ GPT –±–æ–ª–∂–∞–º—ã</h5>
    <div class="bg-light p-4 rounded shadow-sm text-muted">{{ ai_forecast }}</div>
</div>
{% endif %} -->

{% if user.is_authenticated %}
<div class="mt-5">
    <h6 class="text-muted">‚≠ê –¢–∞“£–¥–∞—É–ª—ã –±–∞“ì—ã—Ç—Ç–∞—Ä</h6>
    {% if favorites %}
    <ul class="list-group list-group-flush">
        {% for fav in favorites %}
        <li class="list-group-item d-flex justify-content-between px-0">
            {{ fav.from_currency.code }} ‚Üí {{ fav.to_currency.code }}
            <a class="btn btn-sm btn-link text-danger"
                href="{% url 'remove_from_favorites' fav.from_currency.code fav.to_currency.code %}">”®—à—ñ—Ä—É</a>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p class="text-muted">–¢–∞“£–¥–∞—É–ª—ã –±–∞“ì—ã—Ç—Ç–∞—Ä –∂–æ“õ.</p>
    {% endif %}
</div>
{% endif %}
{% endblock %}